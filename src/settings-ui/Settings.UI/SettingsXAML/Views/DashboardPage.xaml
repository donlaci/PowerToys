<Page
    x:Class="Microsoft.PowerToys.Settings.UI.Views.DashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:custom="using:Microsoft.PowerToys.Settings.UI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:localConverters="using:Microsoft.PowerToys.Settings.UI.Converters"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:toolkit="using:CommunityToolkit.WinUI.Controls"
    xmlns:toolkitConverters="using:CommunityToolkit.WinUI.UI.Converters"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:viewmodels="using:Microsoft.PowerToys.Settings.UI.ViewModels"
    AutomationProperties.LandmarkType="Main"
    DataContext="DashboardViewModel"
    mc:Ignorable="d">

    <Page.Resources>
        <localConverters:UpdateStateToBoolConverter x:Key="UpdateStateToBoolConverter" />
        <toolkitConverters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <toolkitConverters:BoolNegationConverter x:Key="BoolNegationConverter" />
        <toolkitConverters:BoolToVisibilityConverter
            x:Key="BoolToInvertedVisibilityConverter"
            FalseValue="Visible"
            TrueValue="Collapsed" />
    </Page.Resources>
    <Grid Margin="16,0,0,0" RowSpacing="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="700" />
                    </VisualState.StateTriggers>
                </VisualState>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="ModulesGrid.(Grid.Column)" Value="0" />
                        <Setter Target="DashboardView.(Grid.Row)" Value="1" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        <TextBlock
            x:Uid="DashboardTitle"
            VerticalAlignment="Center"
            Style="{StaticResource TitleTextBlockStyle}" />
        <Button
            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
            Style="{StaticResource SubtleButtonStyle}"
            Click="AddButtonClick"
            HorizontalAlignment="Right"
            VerticalAlignment="Center"
            Width="64"
            Margin="0,0,32,0">
            <Button.Content>
                <FontIcon FontSize="24" Glyph="{x:Bind ViewModel.AddButtonGlyph, Mode=OneWay}" />
            </Button.Content>
        </Button>

        <InfoBar
            x:Uid="UpdateAvailable"
            Margin="0,0,16,0"
            HorizontalAlignment="Right"
            VerticalAlignment="Center"
            IsClosable="False"
            IsOpen="{x:Bind ViewModel.UpdateAvailable, Mode=OneWay}"
            Severity="Success">
            <InfoBar.ActionButton>
                <Button x:Uid="LearnMore" Click="SWVersionButtonClicked" />
            </InfoBar.ActionButton>
        </InfoBar>

        <ScrollViewer Grid.Row="1">
            <Grid
                Margin="0,0,16,0"
                ColumnSpacing="16"
                RowSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Grid
                    x:Name="ModulesGrid"
                    Grid.Column="1"
                    MinWidth="360"
                    VerticalAlignment="Top"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource OverlayCornerRadius}"
                    Visibility="{x:Bind ViewModel.IsAddPanelVisible, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}"
                    RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <TextBlock
                        Grid.Row="0"
                        Margin="16,16,0,16"
                        Style="{StaticResource BodyStrongTextBlockStyle}"
                        Text="All modules" />
                    <ItemsRepeater 
                        Grid.Row="1" 
                        ItemsSource="{x:Bind ViewModel.AllModules, Mode=OneWay}">
                        <ItemsRepeater.Layout>
                            <StackLayout Orientation="Vertical" />
                        </ItemsRepeater.Layout>
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="viewmodels:DashboardListItem">
                                <Grid
                                    Height="56"
                                    Padding="20,0,20,0"
                                    BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                    BorderThickness="0,1,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Image Width="20" Margin="0,0,16,0">
                                        <Image.Source>
                                            <BitmapImage UriSource="{x:Bind Icon, Mode=OneWay}" />
                                        </Image.Source>
                                    </Image>
                                    <TextBlock
                                        Grid.Column="1"
                                        VerticalAlignment="Center"
                                        Text="{x:Bind Label, Mode=OneWay}"
                                        TextTrimming="CharacterEllipsis" />
                                    <FontIcon
                                        Grid.Column="2"
                                        Width="20"
                                        Margin="0,0,16,0"
                                        FontSize="16"
                                        Glyph="&#xE72E;"
                                        Visibility="{x:Bind IsLocked, Converter={StaticResource BoolToInvertedVisibilityConverter}, ConverterParameter=True, Mode=OneWay}">
                                        <ToolTipService.ToolTip>
                                            <TextBlock x:Uid="GPO_IsSettingForcedText" />
                                        </ToolTipService.ToolTip>
                                    </FontIcon>
                                    <ToggleSwitch
                                        Grid.Column="3"
                                        Margin="0,0,0,0"
                                        HorizontalAlignment="Right"
                                        IsEnabled="{x:Bind IsLocked, Converter={StaticResource BoolNegationConverter}, ConverterParameter=True, Mode=OneWay}"
                                        IsOn="{x:Bind IsEnabled, Mode=TwoWay}"
                                        OffContent=""
                                        OnContent=""
                                        Style="{StaticResource RightAlignedCompactToggleSwitchStyle}" />
                                </Grid>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                </Grid>
                <ItemsRepeater x:Name="DashboardView" ItemsSource="{x:Bind ViewModel.ActiveModules, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                        <toolkit:StaggeredLayout
                            ColumnSpacing="8"
                            DesiredColumnWidth="420"
                            RowSpacing="8" />
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:DashboardListItem">
                            <Grid
                                Padding="16"
                                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="{StaticResource OverlayCornerRadius}"
                                RowSpacing="12">
                                <Grid.RowDefinitions>
                                    <RowDefinition />
                                    <RowDefinition />
                                </Grid.RowDefinitions>
                                <Grid ColumnSpacing="12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Image Width="20" Margin="0,0,0,0">
                                        <Image.Source>
                                            <BitmapImage UriSource="{x:Bind Icon, Mode=OneWay}" />
                                        </Image.Source>
                                    </Image>
                                    <TextBlock
                                        Grid.Column="1"
                                        VerticalAlignment="Center"
                                        FontWeight="SemiBold"
                                        Text="{x:Bind Label, Mode=OneWay}"
                                        TextTrimming="CharacterEllipsis" />
                                    <FontIcon
                                        Grid.Column="2"
                                        Width="20"
                                        Margin="0,0,16,0"
                                        FontSize="16"
                                        Glyph="&#xE72E;"
                                        Visibility="{x:Bind IsLocked, Converter={StaticResource BoolToInvertedVisibilityConverter}, ConverterParameter=True, Mode=OneWay}">
                                        <ToolTipService.ToolTip>
                                            <TextBlock x:Uid="GPO_IsSettingForcedText" />
                                        </ToolTipService.ToolTip>
                                    </FontIcon>
                                    <ToggleSwitch
                                        Grid.Column="3"
                                        Margin="0,0,0,0"
                                        HorizontalAlignment="Right"
                                        IsEnabled="{x:Bind IsLocked, Converter={StaticResource BoolNegationConverter}, ConverterParameter=True, Mode=OneWay}"
                                        IsOn="{x:Bind IsEnabled, Mode=TwoWay}"
                                        OffContent=""
                                        OnContent=""
                                        Style="{StaticResource RightAlignedCompactToggleSwitchStyle}" />
                                    <Button
                                        Grid.Column="4"
                                        Height="24"
                                        Margin="0,0,-12,0"
                                        Padding="0"
                                        Click="SettingsButtonClicked"
                                        Content="{ui:FontIcon FontSize=14,
                                                              Glyph=&#xE713;}"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                        Style="{StaticResource SubtleButtonStyle}"
                                        Tag="{x:Bind Tag, Mode=OneWay}" />
                                </Grid>
                                <ItemsRepeater 
                                    Grid.Row="1" 
                                    ItemsSource="{x:Bind DashboardModuleItems, Mode=OneWay}"
                                    Visibility="{x:Bind IsEnabled, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}">
                                    <ItemsRepeater.Layout>
                                        <StackLayout Orientation="Vertical" Spacing="4" />
                                    </ItemsRepeater.Layout>
                                    <ItemsRepeater.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:DashboardModuleItem">
                                            <StackPanel Orientation="Vertical" Spacing="4">
                                                <Grid Visibility="{x:Bind IsButtonVisible, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True, Mode=OneWay}">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Border
                                                        Margin="0,0,8,0"
                                                        Padding="8"
                                                        VerticalAlignment="Center"
                                                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="{StaticResource ControlCornerRadius}"
                                                        Visibility="{x:Bind IsShortcutVisible, Mode=OneWay}">
                                                        <ItemsControl
                                                            AutomationProperties.AccessibilityView="Raw"
                                                            IsTabStop="False"
                                                            ItemsSource="{x:Bind Path=Shortcut, Mode=TwoWay}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <StackPanel Orientation="Horizontal" Spacing="12" />
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <custom:KeyVisual
                                                                        VerticalAlignment="Center"
                                                                        AutomationProperties.AccessibilityView="Raw"
                                                                        Content="{Binding}"
                                                                        IsTabStop="False"
                                                                        VisualType="TextOnly" />
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </Border>
                                                    <TextBlock
                                                        Grid.Column="1"
                                                        VerticalAlignment="Center"
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                        Text="{x:Bind Label, Mode=OneWay}"
                                                        TextWrapping="WrapWholeWords" />
                                                </Grid>
                                                <controls:SettingsCard Padding="8" MinHeight="0"
                                                    Click="{x:Bind ButtonClickHandler, Mode=OneWay}"
                                                    Description="{x:Bind ButtonDescription, Mode=OneWay}"
                                                    Header="{x:Bind ButtonTitle, Mode=OneWay}"
                                                    IsClickEnabled="True"
                                                    Visibility="{x:Bind IsButtonVisible, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}">
                                                    <controls:SettingsCard.HeaderIcon>
                                                        <FontIcon Glyph="{x:Bind ButtonGlyph, Mode=OneWay}" />
                                                    </controls:SettingsCard.HeaderIcon>
                                                    <controls:SettingsCard.ActionIcon>
                                                        <FontIcon Glyph="&#xE8A7;" />
                                                    </controls:SettingsCard.ActionIcon>
                                                    <controls:SettingsCard.Resources>
                                                        <x:Double x:Key="SettingsCardHeaderIconMaxSize">14</x:Double>
                                                        <Thickness x:Key="SettingsCardHeaderIconMargin">4,0,12,0</Thickness>
                                                    </controls:SettingsCard.Resources>
                                                </controls:SettingsCard>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsRepeater.ItemTemplate>
                                </ItemsRepeater>
                            </Grid>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </Grid>
        </ScrollViewer>
    </Grid>
</Page>